<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="CANCEL_BID" directorySegmentName="seg_0" id="3B210552-5575-A65B-831B-C2D6B815FAF2">
<sourceConnName>cocoFarm</sourceConnName>
<sourceObjSchema>COCOFARM</sourceObjSchema>
<sourceObjName>CANCEL_BID</sourceObjName>
<createdBy>Sonn</createdBy>
<createdTime>2018-06-17 09:48:31 UTC</createdTime>
<ownerDesignName>cocoDataModel</ownerDesignName>
<owner>9B2CBDD9-D4EA-AD8B-3936-1238B79FFDD3</owner>
<source>CREATE OR REPLACE procedure COCOFARM.CANCEL_BID (in_auction_idx AUCTION.IDX%type, in_amount AUCTION.HIGHEST_BID%type, in_bidder_idx BID.BIDDER_IDX%type, isDone out number)&lt;br/&gt;is&lt;br/&gt;	null_checker		number;&lt;br/&gt;	auction_state		AUCTION.STATE_CODE%type;&lt;br/&gt;	bid_state			BID.STATE_CODE%type;&lt;br/&gt;	auction_title		AUCTION.TITLE%type;&lt;br/&gt;	auction_writter		AUCTION.WRITTER_IDX%type;&lt;br/&gt;	karma_point			BAD_DEED_TYPE.KARMA%type;&lt;br/&gt;	next_amount			BID_ALIVE_QUE.BID_AMOUNT%type;&lt;br/&gt;	next_bidder			BID_ALIVE_QUE.BIDDER_IDX%type;&lt;br/&gt;	timewindow			timestamp;&lt;br/&gt;&lt;br/&gt;	err_code			number;&lt;br/&gt;	err_message			varchar2(255);&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;&lt;br/&gt;	select count(1) into null_checker from BID where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount;&lt;br/&gt;&lt;br/&gt;	if(null_checker =0) then&lt;br/&gt;		insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;, -1, &apos;No such Bid exists. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;		select -1 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;	else&lt;br/&gt;		select count(1) into null_checker from BID where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount and BIDDER_IDX = in_bidder_idx;&lt;br/&gt;&lt;br/&gt;		if (null_checker =0) then&lt;br/&gt;			insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;, -2, &apos;Calcel request is not from a bidder. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;			select -2 into isDone from DUAL;&lt;br/&gt;		else&lt;br/&gt;			select A.WRITTER_IDX, A.TITLE, A.STATE_CODE, B.STATE_CODE into auction_writter, auction_title, auction_state, bid_state from AUCTION A inner join BID B on B.AUCTION_IDX = A.IDX where A.IDX = in_auction_idx and B.AUCTION_IDX = in_auction_idx and B.AMOUNT = in_amount;&lt;br/&gt;&lt;br/&gt;			if (auction_writter is null or auction_title is null or bid_state is null) then&lt;br/&gt;				insert into PLOGGER (NAME, RESULTCODE, CONTENT, ERR_CODE) values (&apos;CANCEL_BID&apos;, -7, &apos;Something&apos;&apos;s wrong! This shouldn&apos;&apos;t be here. Check &apos;&apos;CANCEL_BID&apos;&apos; procedure code. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;, -1);&lt;br/&gt;				select -7 into isDone from DUAL;&lt;br/&gt;			else&lt;br/&gt;				if (bid_state &lt;&gt;1 and bid_state&lt;&gt;2 and bid_state&lt;&gt;3 and bid_state&lt;&gt;4) then&lt;br/&gt;					insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;, -3, &apos;Bid is not alive. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;					select -3 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;				elsif (auction_state &lt;&gt;1 and auction_state &lt;&gt;5) then&lt;br/&gt;					insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;, -4, &apos;Cannot cancel bid on current state of target auction. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;					select -4 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;				elsif (auction_state =1) then&lt;br/&gt;					delete BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx and BID_AMOUNT = in_amount and BIDDER_IDX = in_bidder_idx;&lt;br/&gt;&lt;br/&gt;					if (bid_state =1) then&lt;br/&gt;						select count(1) into null_checker from BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx;&lt;br/&gt;&lt;br/&gt;						if (null_checker =0) then&lt;br/&gt;							update AUCTION set HIGHEST_BID = START_PRICE where IDX = in_auction_idx;&lt;br/&gt;						else&lt;br/&gt;							select max(BID_AMOUNT) into next_amount from BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx;&lt;br/&gt;							update AUCTION set HIGHEST_BID = next_amount where IDX = in_auction_idx;&lt;br/&gt;							update BID set STATE_CODE = 1 where AUCTION_IDX = in_auction_idx and AMOUNT = next_amount;&lt;br/&gt;						end if;&lt;br/&gt;&lt;br/&gt;						update BID set STATE_CODE = 10, FINISHED_WHEN = SYSTIMESTAMP where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount;&lt;br/&gt;						insert into BAD_DEED_RECORD (CULPRIT_IDX, DEED_CODE) values (in_bidder_idx, 2);&lt;br/&gt;						select KARMA into karma_point from BAD_DEED_TYPE where CODE = 2;&lt;br/&gt;						insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, in_bidder_idx, &apos;&apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 입찰을 취소하셨습니다.&apos;,&apos;진행중 인 경매에 대해 최고 입찰 상태에서 취소하셨기 때문에 벌점 &apos;||karma_point||&apos;점을 받으셨습니다.&apos;,1);&lt;br/&gt;						insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;,1,&apos;Successfully canceled a bid. It was the Highest Bid. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;						select 1 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;					elsif ( bid_state =2) then&lt;br/&gt;						update BID set STATE_CODE = 11, FINISHED_WHEN = SYSTIMESTAMP where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount;&lt;br/&gt;						insert into BAD_DEED_RECORD (CULPRIT_IDX, DEED_CODE) values (in_bidder_idx, 3);&lt;br/&gt;						select KARMA into karma_point from BAD_DEED_TYPE where CODE = 3;&lt;br/&gt;						insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, in_bidder_idx, &apos;&apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 입찰을 취소하셨습니다.&apos;,&apos;진행중 인 경매에 대해 최고 입찰이 아닌 상태에서 취소하셨기 때문에 벌점 &apos;||karma_point||&apos;점을 받으셨습니다.&apos;,1);&lt;br/&gt;						insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;,1,&apos;Successfully canceled a bid. It was not the Highest Bid. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;						select 1 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;					else&lt;br/&gt;						insert into PLOGGER (NAME, RESULTCODE, CONTENT, ERR_CODE) values (&apos;CANCEL_BID&apos;, -5, &apos;Something&apos;&apos;s wrong! This shouldn&apos;&apos;t be here. Check &apos;&apos;CANCEL_BID&apos;&apos; procedure code. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;, -1);&lt;br/&gt;						select -5 into isDone from DUAL;&lt;br/&gt;					end if;&lt;br/&gt;&lt;br/&gt;				elsif (auction_state =5) then&lt;br/&gt;					delete BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx and BID_AMOUNT = in_amount and BIDDER_IDX = in_bidder_idx;&lt;br/&gt;					delete BID_CONTRACT_QUE where AUCTION_IDX = in_auction_idx and BID_AMOUNT = in_amount;&lt;br/&gt;&lt;br/&gt;					if (bid_state =3) then&lt;br/&gt;						select count(1) into null_checker from BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx;&lt;br/&gt;&lt;br/&gt;						if (null_checker =0) then&lt;br/&gt;							update AUCTION set STATE_CODE = 7 , FINISHED_WHEN = SYSTIMESTAMP where IDX = in_auction_idx;&lt;br/&gt;							insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, auction_writter, &apos;신청하신 경매 &apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 대금 납부를 모든 입찰인이 거부하였습니다.&apos;,&apos;해당 경매에 참여한 마지막 유효 입찰의 입찰자 가 낙찰 대금의 지불을 거부하여, 해당 경매가 거래 없이 완료되었습니다.&apos;,1);&lt;br/&gt;							insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;,1,&apos;Successfully canceled a bid. It was the Highest Bid. No lesser Alive_Bid found. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;						else&lt;br/&gt;							select B.BIGGEST_BID, Q.BIDDER_IDX into next_amount, next_bidder from BID_ALIVE_QUE Q&lt;br/&gt;								inner join (select max(BID_AMOUNT) BIGGEST_BID from BID_ALIVE_QUE where AUCTION_IDX = in_auction_idx) B&lt;br/&gt;								on B.BIGGEST_BID = Q.BID_AMOUNT&lt;br/&gt;								where AUCTION_IDX = in_auction_idx;&lt;br/&gt;							update BID set STATE_CODE = 3 where AUCTION_IDX = in_auction_idx and AMOUNT = next_amount;&lt;br/&gt;							update AUCTION set HIGHEST_BID = next_amount, STATE_CODE = 6 where IDX = in_auction_idx;&lt;br/&gt;							insert into BID_CONTRACT_QUE (AUCTION_IDX, BID_AMOUNT, CONTRACT_T_WIN_CODE) values (in_auction_idx, next_amount, 4);&lt;br/&gt;							select PAYMENT_DUE into timewindow from BID_CONTRACT_QUE where AUCTION_IDX = in_auction_idx;&lt;br/&gt;							insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, next_bidder, &apos;입찰하신 경매 &apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 에 낙찰되셨습니다.&apos;, &apos;상위 입찰이 취소되어 해당 경매 &apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 에 낙찰되셨습니다. &apos;||to_char(timewindow,&apos;YYYY-MM-DD HH24:MI:SS&apos;)||&apos; 까지 &apos;||next_amount||&apos;원 을 지불하셔야 낙찰이 완료됩니다. 그렇지 않을 시, 낙찰 권한이 차등위 입찰로 넘어가고 계약 위반에 대해 제재를 받을 수 있음을 알려드립니다.&apos;, 1);&lt;br/&gt;							insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, auction_writter, &apos;신청하신 경매 &apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 대금 납부를 최고 입찰자가 거부하였습니다.&apos;,&apos;해당 경매의 최고 입찰자가 낙찰 대금을 지불기한 내 지불을 하지 않아, 차등위 입찰로 낙찰 권한이 이양되었습니다. 차등위 입찰의 입찰금: &apos;||next_amount||&apos;원&apos;,1);&lt;br/&gt;							insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;,1,&apos;Successfully canceled a bid. It was the Highest Bid. lesser Alive_Bid found. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;						end if;&lt;br/&gt;&lt;br/&gt;						update BID set STATE_CODE = 14, FINISHED_WHEN = SYSTIMESTAMP where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount;&lt;br/&gt;						insert into BAD_DEED_RECORD (CULPRIT_IDX, DEED_CODE) values (in_bidder_idx, 4);&lt;br/&gt;						select KARMA into karma_point from BAD_DEED_TYPE where CODE = 4;&lt;br/&gt;						insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, in_bidder_idx, &apos;&apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 입찰을 취소하셨습니다.&apos;,&apos;만료된 경매에 대해 최고 입찰인 상태에서 취소하셨기 때문에 벌점 &apos;||karma_point||&apos;점을 받으셨습니다.&apos;,1);&lt;br/&gt;						select 1 into isDone from DUAL;&lt;br/&gt;&lt;br/&gt;					elsif (bid_state =4) then&lt;br/&gt;						update BID set STATE_CODE = 15, FINISHED_WHEN = SYSTIMESTAMP where AUCTION_IDX = in_auction_idx and AMOUNT = in_amount;&lt;br/&gt;						insert into BAD_DEED_RECORD (CULPRIT_IDX, DEED_CODE) values (in_bidder_idx, 5);&lt;br/&gt;						select KARMA into karma_point from BAD_DEED_TYPE where CODE = 5;&lt;br/&gt;						insert into MESSAGE (SENDER_IDX, RECEIVER_IDX, TITLE, CONTENT, TYPE_CODE) values (0, in_bidder_idx, &apos;&apos;&apos;&apos;||auction_title||&apos;&apos;&apos; 의 입찰을 취소하셨습니다.&apos;,&apos;만료된 경매에 대해 최고 입찰이 아닌 상태에서 취소하셨기 때문에 벌점 &apos;||karma_point||&apos;점을 받으셨습니다.&apos;,1);&lt;br/&gt;						insert into PLOGGER (NAME, RESULTCODE, CONTENT) values (&apos;CANCEL_BID&apos;,1,&apos;Successfully canceled a bid. It was not Highest Bid. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;);&lt;br/&gt;						select 1 into isDone from DUAL;&lt;br/&gt;					else&lt;br/&gt;						insert into PLOGGER (NAME, RESULTCODE, CONTENT, ERR_CODE) values (&apos;CANCEL_BID&apos;, -5, &apos;Something&apos;&apos;s wrong! This shouldn&apos;&apos;t be here. Check &apos;&apos;CANCEL_BID&apos;&apos; procedure code. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;, -1);&lt;br/&gt;						select -5 into isDone from DUAL;&lt;br/&gt;					end if;&lt;br/&gt;				else&lt;br/&gt;					insert into PLOGGER (NAME, RESULTCODE, CONTENT, ERR_CODE) values (&apos;CANCEL_BID&apos;, -6, &apos;Something&apos;&apos;s wrong! This shouldn&apos;&apos;t be here. Check &apos;&apos;CANCEL_BID&apos;&apos; procedure code. [in_auction_idx: &apos;||in_auction_idx||&apos;, in_amount: &apos;||in_amount||&apos;, in_bidder_idx: &apos;||in_bidder_idx||&apos;]&apos;, -1);&lt;br/&gt;					select -6 into isDone from DUAL;&lt;br/&gt;				end if;&lt;br/&gt;&lt;br/&gt;			end if;&lt;br/&gt;&lt;br/&gt;		end if;&lt;br/&gt;&lt;br/&gt;	end if;&lt;br/&gt;&lt;br/&gt;	commit;&lt;br/&gt;&lt;br/&gt;exception when OTHERS then&lt;br/&gt;&lt;br/&gt;	err_code := sqlcode;&lt;br/&gt;	err_message := substr(sqlerrm, 1, 255);&lt;br/&gt;&lt;br/&gt;	insert into PLOGGER (NAME, RESULTCODE, CONTENT, err_code, err_message)&lt;br/&gt;		values (&apos;CANCEL_BID&apos;, 0, &apos;ERROR!!! ........)&apos;, err_code, err_message );&lt;br/&gt;	commit;&lt;br/&gt;&lt;br/&gt;	select 0 into isDone from DUAL;&lt;br/&gt;end;</source>
</StoredProcedureOraclev10g>